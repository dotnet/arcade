# BuildDropPath - The root folder of the drop directory for which the manifest file will be generated.
# BuildComponentPath - The folder containing the build components and packages. This folder path is passed as is to the component detection tool to detect packages in this folder. 
# PackageName - The name of the package this SBOM represents.
# PackageVersion - The version of the package this SBOM represents. 
# ManifestDirPath - The path of the directory where the generated manifest files will be placed

parameters:
  BuildDropPath: ''
  BuildComponentPath: ''
  PackageName: '.NET'
  PackageVersion: '7.0'
  ManifestDirPath: $(Build.ArtifactStagingDirectory)\sbom
  sbomContinueOnError: true

steps:
- powershell: |
    if (!(Test-Path -path ${{parameters.manifestDirPath}}))
    {
      New-Item -ItemType Directory -path ${{parameters.manifestDirPath}}
    }
  displayName: Create SBOM output folder
  continueOnError: ${{parameters.sbomContinueOnError}}

- task: AzureArtifacts.manifest-generator-task.manifest-generator-task.ManifestGeneratorTask@0
  displayName: 'Generate SBOM manifest'
  continueOnError: ${{parameters.sbomContinueOnError}}
  inputs:
      PackageName: ${{parameters.packageName}}
      BuildDropPath: ${{parameters.buildDropPath}}
      PackageVersion: ${{parameters.packageVersion}}
      ManifestDirPath: ${{parameters.manifestDirPath}}
      BuildComponentPath: ${{parameters.buildComponentPath}}

- task: PublishPipelineArtifact@1
  displayName: Publish SBOM manifest
  continueOnError: ${{parameters.sbomContinueOnError}}
  inputs:
    targetPath: '${{parameters.manifestDirPath}}'
    artifactName: $(System.StageName)_$(Agent.JobName)_SBOM

