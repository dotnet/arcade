
parameters:
  buildSteps: []

steps:
  - bash: |
      /bin/bash ./telemetry/start-job.sh --source "$Source" --type "$Type" --build "$Build" --queue-id "$QueueId" --attempt "$Attempt" -p "operatingSystem=$OperatingSystem" -p "configuration=$Configuration"
    condition: not(in(variables['Agent.OS'], 'Windows_NT'))
    workingDirectory: $(Build.SourcesDirectory)/eng/common
    displayName: Send Job Start Telemetry
    env:
      HelixApiAccessToken: $(HelixApiAccessToken)
      Source: $(HelixSource)
      Type: $(HelixType)
      Build: $(Build.BuildNumber)
      QueueId: $(Agent.OS)
      Attempt: 1
      OperatingSystem: $(Agent.OS)
      Configuration: $(_BuildConfig)

  - powershell: |
      ./telemetry/start-job.ps1 -Source $env:Source -Type $env:Type -Build $env:Build -QueueId $env:QueueId -Attempt $env:Attempt -Properties @{ operatingSystem=$env:OperatingSystem; configuration=$env:Configuration } -Verbose
      if ($LASTEXITCODE -ne 0) {
        exit $LASTEXITCODE
      }
    condition: in(variables['Agent.OS'], 'Windows_NT')
    workingDirectory: $(Build.SourcesDirectory)/eng/common
    displayName: Send Job Start Telemetry
    env:
      HelixApiAccessToken: $(HelixApiAccessToken)
      Source: $(HelixSource)
      Type: $(HelixType)
      Build: $(Build.BuildNumber)
      QueueId: $(Agent.OS)
      Attempt: 1
      OperatingSystem: $(Agent.OS)
      Configuration: $(_BuildConfig)

  - bash: |
      /bin/bash ./telemetry/build/start.sh --build-uri "$BuildUri"
    condition: not(in(variables['Agent.OS'], 'Windows_NT'))
    workingDirectory: $(Build.SourcesDirectory)/eng/common
    displayName: Send Build Start Telemetry
    env:
      BuildUri: https://devdiv.visualstudio.com/DevDiv/_build/index?buildId=$(Build.BuildId)&_a=summary
      Helix_JobToken: $(Helix_JobToken)

  - powershell: |
      ./telemetry/build/start.ps1 -BuildUri $env:BuildUri
      if ($LASTEXITCODE -ne 0) {
        exit $LASTEXITCODE
      }
    condition: in(variables['Agent.OS'], 'Windows_NT')
    workingDirectory: $(Build.SourcesDirectory)/eng/common
    displayName: Send Build Start Telemetry
    env:
      BuildUri: https://devdiv.visualstudio.com/DevDiv/_build/index?buildId=$(Build.BuildId)&_a=summary
      Helix_JobToken: $(Helix_JobToken)

  - ${{ parameters.buildSteps }}

  - bash: |
      /bin/bash ./telemetry/build/end.sh
    condition: not(in(variables['Agent.OS'], 'Windows_NT'))
    workingDirectory: $(Build.SourcesDirectory)/eng/common
    displayName: Send Build End Telemetry
    env:
      Helix_JobToken: $(Helix_JobToken)
      Helix_WorkItemId: $(Helix_WorkItemId)

  - powershell: |
      ./telemetry/build/end.ps1
      if ($LASTEXITCODE -ne 0) {
        exit $LASTEXITCODE
      }
    condition: in(variables['Agent.OS'], 'Windows_NT')
    workingDirectory: $(Build.SourcesDirectory)/eng/common
    displayName: Send Build End Telemetry
    env:
      Helix_JobToken: $(Helix_JobToken)
      Helix_WorkItemId: $(Helix_WorkItemId)

