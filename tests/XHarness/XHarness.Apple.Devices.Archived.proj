<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" />

  <PropertyGroup>
    <XHarnessZippedAppsUrl>https://netcorenativeassets.blob.core.windows.net/resource-packages/external/ios/test-app/tvos-device/multiple-app-bundles.zip</XHarnessZippedAppsUrl>
    <XHarnessTmpDir>$(ArtifactsTmpDir)XHarness.Apple.Device.Archived</XHarnessTmpDir>
  </PropertyGroup>

  <!-- We will download existing zip with two apps inside so that we have coverage for injecting of provisioning profiles into archives -->
  <Target Name="Build" Returns="@(XHarnessAppBundleToTest)">
    <Error Condition=" '$(ArtifactsTmpDir)' == ''" Text="Not downloading AppBundle because ArtifactsTmpDir property is unset" />

    <DownloadFile SourceUrl="$(XHarnessZippedAppsUrl)" DestinationFolder="$(XHarnessTmpDir)" SkipUnchangedFiles="True" Retries="5">
      <Output TaskParameter="DownloadedFile" ItemName="ZippedApps" />
    </DownloadFile>

    <Message Text="Downloaded @(ZippedApps) for XHarness Test purposes" Importance="High" />

    <ItemGroup>
      <XHarnessAppBundleToTest Include="@(ZippedApps)">
        <TestTarget>tvos-device</TestTarget>
        <WorkItemTimeout>00:18:00</WorkItemTimeout>
        <CustomCommands>
          set -x
          result=0
          sign System.Buffers.Tests.app
          sign System.Runtime.Numerics.Tests.app
          xharness apple test -a System.Buffers.Tests.app -o $output_directory -t $target -v --timeout 00:08:50
          ((result|=$?))
          xharness apple test -a System.Runtime.Numerics.Tests.app -o $output_directory -t $target -v --timeout 00:08:50
          ((result|=$?))
          exit $result
        </CustomCommands>
      </XHarnessAppBundleToTest>
    </ItemGroup>
  </Target>

</Project>
