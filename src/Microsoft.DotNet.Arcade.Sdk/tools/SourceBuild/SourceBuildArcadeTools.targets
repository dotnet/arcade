<Project>

  <UsingTask TaskName="Microsoft.DotNet.Arcade.Sdk.SourceBuild.AddSourceToNuGetConfig" AssemblyFile="$(ArcadeSdkBuildTasksAssembly)" />
  <UsingTask TaskName="Microsoft.DotNet.Arcade.Sdk.SourceBuild.ReadSourceBuildIntNupkgDependencies" AssemblyFile="$(ArcadeSdkBuildTasksAssembly)" />

  <Target Name="CollectSourceBuildIntermediateNupkgDependencies"
          Condition="
            '$(ArcadeBuildFromSource)' == 'true' and
            '$(ArcadeInnerBuildFromSource)' == 'true'"
          BeforeTargets="CollectPackageReferences">
    <ReadSourceBuildIntNupkgDependencies
      VersionDetailsXmlFile="$([MSBuild]::NormalizePath('$(RepositoryEngineeringDir)', 'Version.Details.xml'))">
      <Output TaskParameter="Dependencies" ItemName="VersionDetailsSourceBuildElement" />
    </ReadSourceBuildIntNupkgDependencies>

    <PropertyGroup>
      <SourceBuildIntNupkgRid Condition="'$(SourceBuildIntNupkgRid)' == ''">linux-x64</SourceBuildIntNupkgRid>
    </PropertyGroup>

    <ItemGroup Condition="'@(VersionDetailsSourceBuildElement)' != ''">
      <SourceBuildIntNupkgReference
        Include="%(VersionDetailsSourceBuildElement.Identity).$(SourceBuildIntNupkgRid)"
        ExactVersion="%(VersionDetailsSourceBuildElement.Version)" />
      <PackageReference
        Include="@(SourceBuildIntNupkgReference)"
        Version="[%(ExactVersion)]"/>
    </ItemGroup>
  </Target>

  <Target Name="SetUpSourceBuildIntermediateNupkgCache"
          Condition="
            '$(ArcadeBuildFromSource)' == 'true' and
            '$(ArcadeInnerBuildFromSource)' == 'true' and
            '@(SourceBuildIntNupkgReference)' != ''"
          AfterTargets="Restore">
    <PropertyGroup>
      <SourceBuiltNupkgCacheDir>$([MSBuild]::NormalizeDirectory('$(ArtifactsObjDir)', 'source-built-upstream-cache'))</SourceBuiltNupkgCacheDir>
    </PropertyGroup>

    <ItemGroup>
      <IntNupkgSourceDir Include="$([MSBuild]::NormalizeDirectory(
        '$(NuGetPackageRoot)',
        '$([System.String]::new(`%(SourceBuildIntNupkgReference.Identity)`).ToLowerInvariant())',
        '$([System.String]::new(`%(SourceBuildIntNupkgReference.ExactVersion)`).ToLowerInvariant())',
        'artifacts'))" />

      <SourceBuiltNupkgFile Include="%(IntNupkgSourceDir.Identity)**\*.nupkg" />
    </ItemGroup>

    <Copy
      SourceFiles="@(SourceBuiltNupkgFile)"
      DestinationFiles="@(SourceBuiltNupkgFile -> '$(SourceBuiltNupkgCacheDir)%(Filename)%(Extension)')" />

    <AddSourceToNuGetConfig
      NuGetConfigFile="$(RestoreConfigFile)"
      SourceName="source-build-int-nupkg-cache"
      SourcePath="$(SourceBuiltNupkgCacheDir)" />
  </Target>

</Project>
