<Project>

  <PropertyGroup>
    <UpdateDownlevelKnownPacks Condition="'$(UpdateDownlevelKnownPacks)' == '' and
      '$(DotNetBuildSourceOnly)' == 'true' and
      '$(DotNetBuildFromVMR)' == 'true' and
      '$(TargetFrameworkIdentifier)' == '.NETCoreApp' and
      '$(TargetFrameworkVersion)' != '' and
      $([MSBuild]::VersionLessThan('$(TargetFrameworkVersion)', '$(BundledNETCoreAppTargetFrameworkVersion)'))">true</UpdateDownlevelKnownPacks>

    <!-- Disable restoring transitive aspnetcore and windowsdesktop targeting packs to avoid unnecessary dependencies. -->
    <DisableTransitiveFrameworkReferenceDownloads Condition="'$(UpdateDownlevelKnownPacks)' == 'true'">true</DisableTransitiveFrameworkReferenceDownloads>
  </PropertyGroup>

  <ItemGroup Condition="'$(UpdateDownlevelKnownPacks)' == 'true'">
    <!-- Downgrade targeting pack versions to X.0.0 as only those are provided by SBRP. -->
    <KnownFrameworkReference Update="@(KnownFrameworkReference->WithMetadataValue('Identity', 'Microsoft.NETCore.App'))">
      <TargetingPackVersion Condition="$([System.Text.RegularExpressions.Regex]::IsMatch('%(TargetFramework)', '^net\d+\.0$'))">$([System.Text.RegularExpressions.Regex]::Match('%(TargetFramework)', '\d+').Value).0.0</TargetingPackVersion>
    </KnownFrameworkReference>
    <KnownFrameworkReference Update="@(KnownFrameworkReference->WithMetadataValue('Identity', 'Microsoft.AspNetCore.App'))">
      <TargetingPackVersion Condition="'%(TargetFramework)' == 'net6.0'">6.0.2</TargetingPackVersion>
    </KnownFrameworkReference>

    <!-- This is a bit hacky as it uses the newer host pack from the current framework for downlevel TFMs. But given that the host interface is stable, this should be fine. -->
    <KnownAppHostPack Update="@(KnownAppHostPack)"
      AppHostPackVersion="@(KnownAppHostPack->WithMetadataValue('TargetFramework', '$(BundledNETCoreAppTargetFramework)')->Metadata('AppHostPackVersion'))"
      AppHostRuntimeIdentifiers="@(KnownAppHostPack->WithMetadataValue('TargetFramework', '$(BundledNETCoreAppTargetFramework)')->Metadata('AppHostRuntimeIdentifiers'))" />

    <!-- This is a bit hacky as it uses the newer ILLinkPack from the current framework for downlevel TFMs. -->
    <KnownILLinkPack Update="@(KnownILLinkPack)" ILLinkPackVersion="@(KnownILLinkPack->WithMetadataValue('TargetFramework', '$(BundledNETCoreAppTargetFramework)')->Metadata('ILLinkPackVersion'))" />
  </ItemGroup>

  <!-- This is a bit hacky as it uses newer analyzers from the current framework for downlevel TFMs.
       Necessary as the non-current targeting packs are missing analyzers which result in compiler errors when using i.e. Regex or LibraryImport attributes.
       This should be fine though as the analyzers target netstandard2.0 and aren't specific to the framework version in general. -->
  <Target Name="AddAnalyzersFromBundledNETCoreAppTargetingPack"
          BeforeTargets="CoreCompile"
          AfterTargets="ResolveTargetingPackAssets;ResolveProjectReferences"
          Condition="'$(UpdateDownlevelKnownPacks)' == 'true' and '$(Language)' == 'C#'">
    <ItemGroup>
      <_BundledAnalyzer Include="$(NetCoreTargetingPackRoot)\Microsoft.NETCore.App.Ref\$(BundledNETCoreAppPackageVersion)\analyzers\dotnet\cs\*.dll" />

      <!-- Filter out analyzers that are already present (i.e. live built and referenced). -->
      <_BundledAnalyzerByName Include="@(_BundledAnalyzer->Metadata('FileName'))" OriginalIdentity="%(Identity)" />
      <_AnalyzerByName Include="@(Analyzer->Metadata('FileName'))" />
      <_BundledAnalyzerByName Remove="@(_AnalyzerByName)" />

      <Analyzer Include="@(_BundledAnalyzerByName->Metadata('OriginalIdentity'))" />
    </ItemGroup>
  </Target>

  <PropertyGroup>
    <!-- These switches control whether known pack items and version updates are enabled for unknown target frameworks. On by default. -->
    <EnableKnownPackItemsForUnknownTargetFramework Condition="'$(EnableKnownPackItemsForUnknownTargetFramework)' == ''">true</EnableKnownPackItemsForUnknownTargetFramework>
    <EnableKnownPackVersionUpdatesForCurrentTargetFramework Condition="'$(EnableKnownPackVersionUpdatesForCurrentTargetFramework)' == ''">true</EnableKnownPackVersionUpdatesForCurrentTargetFramework>

    <TargetingPackCurrentTargetFramework Condition="'$(TargetingPackCurrentTargetFramework)' == ''">$(NetCurrent)</TargetingPackCurrentTargetFramework>
    <TargetingPackBaselineTargetFramework Condition="'$(TargetingPackBaselineTargetFramework)' == ''">$(NetPrevious)</TargetingPackBaselineTargetFramework>
    <TargetingPackBaselineTargetFramework Condition="'$(TargetingPackBaselineTargetFramework)' == ''">$(NetMinimum)</TargetingPackBaselineTargetFramework>
  </PropertyGroup>

  <!-- Add Known* items if the SDK doesn't support the TargetFramework yet. Uses the metadata from the `TargetingPackBaselineTargetFramework`, which includes versions. -->
  <ItemGroup Condition="'$(EnableKnownPackItemsForUnknownTargetFramework)' == 'true'">
    <KnownFrameworkReference
      Include="@(KnownFrameworkReference->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('TargetFramework', '$(TargetingPackBaselineTargetFramework)'))"
      TargetFramework="$(TargetingPackCurrentTargetFramework)"
      Condition="'@(KnownFrameworkReference->AnyHaveMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))' != 'true'" />

    <KnownRuntimePack
      Include="@(KnownRuntimePack->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('TargetFramework', '$(TargetingPackBaselineTargetFramework)')->WithMetadataValue('RuntimePackLabels', 'Mono'))"
      TargetFramework="$(TargetingPackCurrentTargetFramework)"
      Condition="'@(KnownRuntimePack->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('RuntimePackLabels', 'Mono')->AnyHaveMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))' != 'true'" />

    <KnownRuntimePack
      Include="@(KnownRuntimePack->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('TargetFramework', '$(TargetingPackBaselineTargetFramework)')->WithMetadataValue('RuntimePackLabels', 'NativeAOT'))"
      TargetFramework="$(TargetingPackCurrentTargetFramework)"
      Condition="'@(KnownRuntimePack->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('RuntimePackLabels', 'NativeAOT')->AnyHaveMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))' != 'true'" />

    <KnownILCompilerPack
      Include="@(KnownILCompilerPack->WithMetadataValue('Identity', 'Microsoft.DotNet.ILCompiler')->WithMetadataValue('TargetFramework', '$(TargetingPackBaselineTargetFramework)'))"
      TargetFramework="$(TargetingPackCurrentTargetFramework)"
      Condition="'@(KnownILCompilerPack->AnyHaveMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))' != 'true'" />

    <KnownCrossgen2Pack
      Include="@(KnownCrossgen2Pack->WithMetadataValue('Identity', 'Microsoft.NETCore.App.Crossgen2')->WithMetadataValue('TargetFramework', '$(TargetingPackBaselineTargetFramework)'))"
      TargetFramework="$(TargetingPackCurrentTargetFramework)"
      Condition="'@(KnownCrossgen2Pack->AnyHaveMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))' != 'true'" />

    <KnownAppHostPack
      Include="@(KnownAppHostPack->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('TargetFramework', '$(TargetingPackBaselineTargetFramework)'))"
      TargetFramework="$(TargetingPackCurrentTargetFramework)"
      Condition="'@(KnownAppHostPack->AnyHaveMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))' != 'true'" />

    <KnownILLinkPack
      Include="@(KnownILLinkPack->WithMetadataValue('Identity', 'Microsoft.NET.ILLink.Tasks')->WithMetadataValue('TargetFramework', '$(TargetingPackBaselineTargetFramework)'))"
      TargetFramework="$(TargetingPackCurrentTargetFramework)"
      Condition="'@(KnownILLinkPack->AnyHaveMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))' != 'true'" />
  </ItemGroup>

  <!--
    When .NET gets built from source, make the SDK aware there are bootstrap packages
    for Microsoft.NETCore.App.Runtime.<rid> and Microsoft.NETCore.App.Crossgen2.<rid>.
  -->
  <ItemGroup Condition="'$(DotNetBuildSourceOnly)' == 'true'">
    <KnownRuntimePack Update="@(KnownRuntimePack->WithMetadataValue('Identity', 'Microsoft.NETCore.App'))">
      <RuntimePackRuntimeIdentifiers>%(RuntimePackRuntimeIdentifiers);$(NETCoreSdkRuntimeIdentifier)</RuntimePackRuntimeIdentifiers>
    </KnownRuntimePack>
    <KnownCrossgen2Pack Update="@(KnownCrossgen2Pack->WithMetadataValue('Identity', 'Microsoft.NETCore.App.Crossgen2'))">
      <Crossgen2RuntimeIdentifiers>%(Crossgen2RuntimeIdentifiers);$(NETCoreSdkRuntimeIdentifier)</Crossgen2RuntimeIdentifiers>
    </KnownCrossgen2Pack>
  </ItemGroup>

  <!--
    The following properties can be set to update known pack versions for the current TargetFramework:
    - KnownFrameworkReferenceMicrosoftNETCoreAppCurrentDefaultRuntimeFrameworkVersion
    - KnownFrameworkReferenceMicrosoftNETCoreAppCurrentLatestRuntimeFrameworkVersion
    - KnownFrameworkReferenceMicrosoftNETCoreAppCurrentTargetingPackVersion
    - KnownRuntimePackMicrosoftNETCoreAppCurrentMonoLatestRuntimeFrameworkVersion
    - KnownRuntimePackMicrosoftNETCoreAppCurrentNativeAOTLatestRuntimeFrameworkVersion
    - KnownILCompilerPackCurrentVersion
    - KnownCrossgen2PackCurrentVersion
    - KnownAppHostPackCurrentVersion
    - KnownILLinkPackCurrentVersion
  -->
  <ItemGroup Condition="'$(EnableKnownPackVersionUpdatesForCurrentTargetFramework)' == 'true'">
    <KnownFrameworkReference Update="@(KnownFrameworkReference->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))">
      <DefaultRuntimeFrameworkVersion Condition="'$(KnownFrameworkReferenceMicrosoftNETCoreAppCurrentDefaultRuntimeFrameworkVersion)' != ''">$(KnownFrameworkReferenceMicrosoftNETCoreAppCurrentDefaultRuntimeFrameworkVersion)</DefaultRuntimeFrameworkVersion>
      <LatestRuntimeFrameworkVersion Condition="'$(KnownFrameworkReferenceMicrosoftNETCoreAppCurrentLatestRuntimeFrameworkVersion)' != ''">$(KnownFrameworkReferenceMicrosoftNETCoreAppCurrentLatestRuntimeFrameworkVersion)</LatestRuntimeFrameworkVersion>
      <TargetingPackVersion Condition="'$(KnownFrameworkReferenceMicrosoftNETCoreAppCurrentTargetingPackVersion)' != ''">$(KnownFrameworkReferenceMicrosoftNETCoreAppCurrentTargetingPackVersion)</TargetingPackVersion>
    </KnownFrameworkReference>

    <KnownRuntimePack Update="@(KnownRuntimePack->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)')->WithMetadataValue('RuntimePackLabels', 'Mono'))">
      <LatestRuntimeFrameworkVersion Condition="'$(KnownRuntimePackMicrosoftNETCoreAppCurrentMonoLatestRuntimeFrameworkVersion)' != ''">$(KnownRuntimePackMicrosoftNETCoreAppCurrentMonoLatestRuntimeFrameworkVersion)</LatestRuntimeFrameworkVersion>
    </KnownRuntimePack>

    <KnownRuntimePack Update="@(KnownRuntimePack->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)')->WithMetadataValue('RuntimePackLabels', 'NativeAOT'))">
      <LatestRuntimeFrameworkVersion Condition="'$(KnownRuntimePackMicrosoftNETCoreAppCurrentNativeAOTLatestRuntimeFrameworkVersion)' != ''">$(KnownRuntimePackMicrosoftNETCoreAppCurrentNativeAOTLatestRuntimeFrameworkVersion)</LatestRuntimeFrameworkVersion>
    </KnownRuntimePack>

    <KnownILCompilerPack Update="@(KnownILCompilerPack->WithMetadataValue('Identity', 'Microsoft.DotNet.ILCompiler')->WithMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))">
      <ILCompilerPackVersion Condition="'$(KnownILCompilerPackCurrentVersion)' != ''">$(KnownILCompilerPackCurrentVersion)</ILCompilerPackVersion>
    </KnownILCompilerPack>

    <KnownCrossgen2Pack Update="@(KnownCrossgen2Pack->WithMetadataValue('Identity', 'Microsoft.NETCore.App.Crossgen2')->WithMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))">
      <Crossgen2PackVersion Condition="'$(KnownCrossgen2PackCurrentVersion)' != ''">$(KnownCrossgen2PackCurrentVersion)</Crossgen2PackVersion>
    </KnownCrossgen2Pack>

    <KnownAppHostPack Update="@(KnownAppHostPack->WithMetadataValue('Identity', 'Microsoft.NETCore.App')->WithMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))">
      <AppHostPackVersion Condition="'$(KnownAppHostPackCurrentVersion)' != ''">$(KnownAppHostPackCurrentVersion)</AppHostPackVersion>
    </KnownAppHostPack>

    <KnownILLinkPack Update="@(KnownILLinkPack->WithMetadataValue('Identity', 'Microsoft.NET.ILLink.Tasks')->WithMetadataValue('TargetFramework', '$(TargetingPackCurrentTargetFramework)'))">
      <ILLinkPackVersion Condition="'$(KnownILLinkPackCurrentVersion)' != ''">$(KnownILLinkPackCurrentVersion)</ILLinkPackVersion>
    </KnownILLinkPack>
  </ItemGroup>

</Project>
