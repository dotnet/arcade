<Project>
  <Target Name="_CreateSharedFrameworkArchive"
          DependsOnTargets="_CalculatePackageInformation"
          Condition="'$(SkipBuild)' != 'true'">
    <PropertyGroup>
      <_SharedFrameworkOutputPathRoot>$(IntermediateOutputPath)sharedFramework/</_SharedFrameworkOutputPathRoot>
      <_ArchiveFileName>$(SharedFrameworkArchiveName)-$(Version)</_ArchiveFileName>
      <_ArchiveFileName Condition="'$(RuntimeIdentifier)' != ''">$(SharedFrameworkArchiveName)-$(RuntimeIdentifier)-$(Version)</_ArchiveFileName>
    </PropertyGroup>
    <MSBuild Projects="$(MSBuildProjectFullPath)"
             Targets="PublishSharedFrameworkToDisk"
             Properties="SharedFrameworkOutputPath=$(_SharedFrameworkOutputPathRoot)"
             RemoveProperties="@(_GlobalPropertiesToRemoveForPublish)" />

    <MakeDir Directories="$(PackageOutputPath)" />
    <ZipDirectory SourceDirectory="$(_SharedFrameworkOutputPathRoot)"
                  Overwrite="true"
                  DestinationFile="$(PackageOutputPath)/$(_ArchiveFileName).zip"
                  Condition="$([MSBuild]::IsOSPlatform(Windows))"/>
    <Exec Command="tar -C '$(_SharedFrameworkOutputPathRoot)' -czf $(PackageOutputPath)/$(_ArchiveFileName).tar.gz ."
          IgnoreExitCode="true"
          IgnoreStandardErrorWarningFormat="true"
          Condition="!$([MSBuild]::IsOSPlatform(Windows))"/>
  </Target>

  <Target Name="_CreateSharedFrameworkSymbolsArchive"
          DependsOnTargets="_CalculatePackageInformation"
          Condition="'$(CreateSharedFrameworkSymbolsArchive)' == 'true' and '$(SkipBuild)' != 'true'">
    <PropertyGroup>
      <_SharedFrameworkSymbolsOutputPathRoot>$(IntermediateOutputPath)sharedFrameworkSymbols/</_SharedFrameworkSymbolsOutputPathRoot>
      <_ArchiveFileName>$(SharedFrameworkSymbolsArchiveName)-$(Version)</_ArchiveFileName>
      <_ArchiveFileName Condition="'$(RuntimeIdentifier)' != ''">$(SharedFrameworkArchiveName)-$(RuntimeIdentifier)-$(Version)</_ArchiveFileName>
    </PropertyGroup>
    <MSBuild Projects="$(MSBuildProjectFullPath)"
             Targets="PublishSharedFrameworkSymbolsToDisk"
             Properties="SharedFrameworkSymbolsOutputPath=$(_SharedFrameworkSymbolsOutputPathRoot)" />

    <MakeDir Directories="$(PackageOutputPath)" />
    <ZipDirectory SourceDirectory="$(_SharedFrameworkSymbolsOutputPathRoot)"
                  Overwrite="true"
                  DestinationFile="$(PackageOutputPath)/$(_ArchiveFileName).zip"
                  Condition="$([MSBuild]::IsOSPlatform(Windows))"/>
    <Exec Command="tar -C '$(_SharedFrameworkSymbolsOutputPathRoot)' -czf $(PackageOutputPath)/$(_ArchiveFileName).tar.gz ."
          IgnoreExitCode="true"
          IgnoreStandardErrorWarningFormat="true"
          Condition="!$([MSBuild]::IsOSPlatform(Windows))"/>
  </Target>

  <PropertyGroup>
    <BuildDependsOn>
      $(BuildDependsOn);
      _CreateSharedFrameworkArchive;
      _CreateSharedFrameworkSymbolsArchive
    </BuildDependsOn>
  </PropertyGroup>
</Project>