<Project>
  <PropertyGroup Condition="'$(IsPartialFacadeAssembly)' == 'true'">
    <!-- Tell ResolveMatchingContract to run and resolve contract to project reference -->
    <ResolveMatchingContract>true</ResolveMatchingContract>
    <FillPartialFacadeDependsOn>
      $(FillPartialFacadeDependsOn);ResolveMatchingContract
    </FillPartialFacadeDependsOn>
  </PropertyGroup>
  
  <PropertyGroup> 
    <CompileDependsOn Condition="'$(IsPartialFacadeAssembly)' == 'true' and '$(DesignTimeBuild)' != 'true'">
      FillPartialFacadeUsingTask2;$(CompileDependsOn)
    </CompileDependsOn>
  </PropertyGroup>

  <UsingTask TaskName="GenPartialFacadesTask" AssemblyFile="$(_MicrosoftDotNetGenFacadesTaskDir)Microsoft.DotNet.GenFacades.dll" />

  <Target Name="FillPartialFacadeUsingTask2"
          Inputs="@(ResolvedMatchingContract);@(ReferencePath);@(Compile)"
          Outputs="$(OutputSourcePath)"
          DependsOnTargets="$(FillPartialFacadeDependsOn)">  

    <PropertyGroup>
      <ReferenceAssembly>%(ResolvedMatchingContract.Identity)</ReferenceAssembly>
      <OutputSourcePath>$(IntermediateOutputPath)\$(AssemblyTitle).Forwards.cs</OutputSourcePath>
      <GenFacadesIgnoreMissingTypes Condition="'$(GenFacadesIgnoreMissingTypes)' == ''">false</GenFacadesIgnoreMissingTypes>
    </PropertyGroup>
    
    <GenPartialFacadesTask
      ReferencePaths="@(ReferencePath)"
      ReferenceAssembly="$(ReferenceAssembly)"
      CompileFiles="@(Compile)"
      DefineConstants="$(DefineConstants)"
      IgnoreMissingTypes="$(GenFacadesIgnoreMissingTypes)"
      IgnoreMissingTypesList="@(IgnoreMissingTypesList)"
      OutputSourcePath="$(OutputSourcePath)"
      SeedTypePreferences="@(SeedTypePreference)"
    />

    <ItemGroup>
      <FileWrites Include="$(OutputSourcePath)"/>
    </ItemGroup>
    
    <ItemGroup>
      <Compile Condition="Exists($(OutputSourcePath))" Include="$(OutputSourcePath)"/>
    </ItemGroup>
  </Target>
</Project>
