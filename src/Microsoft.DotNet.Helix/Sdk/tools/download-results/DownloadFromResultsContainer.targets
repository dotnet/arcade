<Project>
  <Target Name="DownloadFromResultsContainer"
          Condition="$(WaitForWorkItemCompletion)"
          AfterTargets="CoreTest"
          Inputs="unused"
          Outputs="%(SentJob.Identity)">
    <ItemGroup>
      <_workItemsWithDownloadMetadata Include="@(HelixWorkItem)" Condition="'%(HelixWorkItem.DownloadFilesFromResults)' != ''" />

      <HelixDownloadResultsMetadata Include="HelixQueue=%(SentJob.HelixTargetQueue)" />
      <HelixDownloadResultsMetadata Condition="'$(HelixConfiguration)' != ''" Include="Configuration=$(HelixConfiguration)" />
      <HelixDownloadResultsMetadata Condition="'$(HelixArchitecture)' != ''" Include="Architecture=$(HelixArchitecture)" />
    </ItemGroup>

    <PropertyGroup>
      <HelixResultsDestinationDir Condition="'$(HelixResultsDestinationDir)' == '' AND '$(BUILD_SOURCESDIRECTORY)' != ''">$([MSBuild]::NormalizePath('$(BUILD_SOURCESDIRECTORY)', 'artifacts', helixresults'))</HelixResultsDestinationDir>
    </PropertyGroup>

    <Warning Text="DownloadFromResultsContainer will be skipped for job %(SentJob.Identity) becaue results container uri is empty" Condition="'%(SentJob.ResultsContainerUri)' == ''" />
    <Warning Text="DownloadFromResultsContainer will be skipped because HelixResultsDestinationDir is empty" Condition="'$(HelixResultsDestinationDir)' == ''" />

    <DownloadFromResultsContainer
        Condition="'@(_workItemsWithDownloadMetadata)' != '' AND '%(SentJob.ResultsContainerUri)' != '' AND '$(HelixResultsDestinationDir)' != ''"
        WorkItems="@(_workItemsWithDownloadMetadata)"
        ResultsContainer="%(SentJob.ResultsContainerUri)"
        OutputDirectory="$(HelixResultsDestinationDir)"
        MetadataToWrite="@(HelixDownloadResultsMetadata)"
        JobId="%(SentJob.Identity)"
        ResultsContainerReadSAS="%(SentJob.ResultsContainerReadSAS)" />
  </Target>
</Project>