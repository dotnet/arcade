<!-- Licensed to the .NET Foundation under one or more agreements. The .NET Foundation licenses this file to you under the MIT license. -->
<Project>

  <PropertyGroup>
    <GenAPIAssembly Condition="'$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)\..\tools\netcoreapp3.1\Microsoft.DotNet.GenAPI.dll</GenAPIAssembly>
    <GenAPIAssembly Condition="'$(MSBuildRuntimeType)' != 'Core'">$(MSBuildThisFileDirectory)\..\tools\net472\Microsoft.DotNet.GenAPI.exe</GenAPIAssembly>

    <TargetsTriggeredByCompilation Condition="'$(GenerateReferenceAssemblySource)' == 'true'">
      $(TargetsTriggeredByCompilation);
      GenerateReferenceAssemblySource
    </TargetsTriggeredByCompilation>
  </PropertyGroup>

  <Target Name="_DontBuildProjectReferences"
          Condition="'$(GenerateReferenceAssemblySource)' != 'true'">
    <PropertyGroup>
      <BuildProjectReferences>false</BuildProjectReferences>
    </PropertyGroup>
  </Target>

  <UsingTask TaskName="Microsoft.DotNet.GenAPI.GenAPITask" AssemblyFile="$(GenAPIAssembly)" />

  <Target Name="GenerateReferenceAssemblySource"
          DependsOnTargets="_DontBuildProjectReferences;ResolveAssemblyReferences">
    <ItemGroup Condition="'$(GenAPILibPath)' == ''">
      <!-- build out a list of directories where dependencies are located -->
      <_referencePathDirectories Include="@(ReferencePath->'%(RootDir)%(Directory)'->Distinct())" />
    </ItemGroup>

    <PropertyGroup>
      <GenAPIInputAssembly Condition="'$(GenAPIInputAssembly )' == ''">@(IntermediateAssembly)</GenAPIInputAssembly >
      <GenAPITargetPath Condition="'$(GenAPITargetPath)' == ''">$(TargetDir)$(TargetName).cs</GenAPITargetPath>
      <GenAPILibPath Condition="'$(GenAPILibPath)' == ''">@(_referencePathDirectories)</GenAPILibPath>
      <GenAPIMessageVerbosity Condition="'$(GenAPIMessageVerbosity)' == '' and '$(GenerateReferenceAssemblySource)' == 'true'">low</GenAPIMessageVerbosity>
      <GenAPIMessageVerbosity Condition="'$(GenAPIMessageVerbosity)' == '' and '$(GenerateReferenceAssemblySource)' != 'true'">high</GenAPIMessageVerbosity>
    </PropertyGroup>

    <Microsoft.DotNet.GenAPI.GenAPITask
      Assembly="$(GenAPIInputAssembly)"
      LibPath="$(GenAPILibPath)"
      ApiList="$(GenAPIApiList)"
      OutputPath="$(GenAPITargetPath)"
      HeaderFile="$(GenAPIHeaderFile)"
      WriterType="$(GenAPIWriterType)"
      SyntaxWriterType="$(GenAPISyntaxWriterType)"
      DocIdKinds="$(GenAPIDocIdKinds)"
      ExceptionMessage="$(GenAPIExceptionMessage)"
      GlobalPrefix="$(GenAPIGlobalPrefix)"
      ExcludeApiList="$(GenAPIExcludeApiList)"
      ExcludeAttributesList="$(GenAPIExcludeAttributesList)"
      FollowTypeForwards="$(GenAPIFollowTypeForwards)"
      ApiOnly="$(GenAPIApiOnly)"
      All="$(GenAPIAll)"
      RespectInternals="$(GenAPIRespectInternals)"
      ExcludeCompilerGenerated="$(GenAPIExcludeCompilerGenerated)"
      MemberHeadings="$(GenAPIMemberHeadings)"
      HighlightBaseMembers="$(GenAPIHighlightBaseMembers)"
      HighlightInterfaceMembers="$(GenAPIHighlightInterfaceMembers)"
      AlwaysIncludeBase="$(GenAPIAlwaysIncludeBase)"
      ExcludeMembers="$(GenAPIExcludeMembers)"
      LangVersion="$(GenAPILangVersion)" />

    <Message Text="Generated reference assembly source code: $(GenAPITargetPath)" Importance="$(GenAPIMessageVerbosity)" />
  </Target>

</Project>
