<!-- Licensed to the .NET Foundation under one or more agreements. The .NET Foundation licenses this file to you under the MIT license. -->
<Project>

  <PropertyGroup>
    <MicrosoftDotNetCMakeSdkTaskAssembly Condition="'$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)..\tools\net\Microsoft.DotNet.CMake.Sdk.dll</MicrosoftDotNetCMakeSdkTaskAssembly>
    <MicrosoftDotNetCMakeSdkTaskAssembly Condition="'$(MSBuildRuntimeType)' != 'Core'">$(MSBuildThisFileDirectory)..\tools\netframework\Microsoft.DotNet.CMake.Sdk.dll</MicrosoftDotNetCMakeSdkTaskAssembly>
  </PropertyGroup>

  <UsingTask TaskName="Microsoft.DotNet.CMake.Sdk.GetCMakeArtifactsFromFileApi" AssemblyFile="$(MicrosoftDotNetCMakeSdkTaskAssembly)" />

  <ItemDefinitionGroup>
    <NativeProjectReference>
      <CMakeProject></CMakeProject>
    </NativeProjectReference>
  </ItemDefinitionGroup>
  
  <Target Name="_RestoreNativeProjectReferences" DependsOnTargets="NormalizeNativeProjectReferences" BeforeTargets="_GenerateRestoreGraphProjectEntry">
    <MSBuild Projects="%(NativeProjectReferenceNormalized.CMakeProject)" Targets="Restore" RemoveProperties="RestoreGraphProjectInput" />
  </Target>

  <Target Name="CopyNativeProjectBinaries">
    <ItemGroup Condition="'$(IsMultiConfigurationGenerator)' == 'true'">
      <NativeProjectBinaries Include="$(NativeProjectOutputFolder)\*.*" />
    </ItemGroup>
    <ItemGroup Condition="'$(IsMultiConfigurationGenerator)' != 'true'">

    <!-- ############################################################### -->
    <!-- The following is required because the single configuration      -->
    <!-- generators, unlike multi-configuration generators,              -->
    <!-- do not place the binaries built into a separate                 -->
    <!-- Debug/Checked/Release directory. Therefore we must filter       -->
    <!-- the folder to only include dynamic libraries, static libraries  -->
    <!--  and executables.                                               -->
    <!--                                                                 -->
    <!-- Please take care when modifying the following lines of code.    -->
    <!-- ############################################################### -->

    <!-- Include everything and then filter. -->
    <NativeProjectBinariesMatched Include="$(NativeProjectOutputFolder)\*.*" />

    <!-- Filter executables on unix -->
    <NativeProjectBinariesExeFilter Condition="'%(Extension)' == ''" Include="@(NativeProjectBinariesMatched)" />
    
    <!-- Filter executables on Windows -->
    <NativeProjectBinariesExeFilter Condition="'%(Extension)' == '.exe'" Include="@(NativeProjectBinariesMatched)" />

    <!-- Filter out the *Make* files -->
    <NativeProjectBinariesExeFilterRemovedMakeFile Condition="'%(FileName)' != 'Makefile'" Include="@(NativeProjectBinariesExeFilter)" />

    <!-- Filter .dylib files for OSX -->
    <NativeProjectBinariesDyLibFilter Condition="'%(Extension)' == '.dylib'" Include="@(NativeProjectBinariesMatched)" />

    <!-- Filter .so files for Linux -->
    <NativeProjectBinariesDyLibFilter Condition="'%(Extension)' == '.so'" Include="@(NativeProjectBinariesMatched)" />

    <!-- Filter static lib files for Unix -->
    <NativeProjectBinariesStaticLibFilter Condition="'%(Extension)' == '.a'" Include="@(NativeProjectBinariesMatched)" />

    <!-- Filter dynamic lib files for Windows -->
    <NativeProjectBinariesDyLibFilter Condition="'%(Extension)' == '.dll'" Include="@(NativeProjectBinariesMatched)" />

    <!-- Filter symbol files for Windows -->
    <NativeProjectsBinariesSymbolsFilter Condition="'%(Extension)' == '.pdb'" Include="@(NativeProjectBinariesMatched)" />

    <!-- Filter static lib files for Windows -->
    <NativeProjectBinariesStaticLibFilter Condition="'%(Extension)' == '.lib'" Include="@(NativeProjectBinariesMatched)" />

    <!-- Merge the filtered lists -->
    <NativeProjectBinaries Include="@(NativeProjectBinariesExeFilterRemovedMakeFile)" />
    <NativeProjectBinaries Include="@(NativeProjectBinariesDyLibFilter)" />
    <NativeProjectBinaries Include="@(NativeProjectBinariesStaticLibFilter)" />
    <NativeProjectBinaries Include="@(NativeProjectsBinariesSymbolsFilter)" />

    </ItemGroup>

    <Error  Text="The native project files are missing in '$(NativeProjectOutputFolder)'. Please build '$(ReferencedCMakeProject)' at least once."
            Condition="'@(NativeProjectBinaries)' == ''" />

    <Copy
      SourceFiles="@(NativeProjectBinaries)"
      DestinationFiles="@(NativeProjectBinaries -> '$(OutDir)%(Filename)%(Extension)')"
      SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
      OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
      Retries="$(CopyRetryCount)"
      RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
      UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)">
      <Output TaskParameter="DestinationFiles" ItemName="FileWrites" />
    </Copy>

    <ItemGroup>
      <FileWrites Include="@(NativeProjectBinaries -> '$(OutDir)%(Filename)%(Extension)')" />
    </ItemGroup>
  </Target>

  <Target Name="NormalizeNativeProjectReferences"
          Condition="'@(NativeProjectReference)' != ''"
          BeforeTargets="ConsolidateNativeProjectReference" >
    <ItemGroup>
      <NativeProjectReferenceNormalized Include="@(NativeProjectReference -> '%(FullPath)')" />
    </ItemGroup>

    <PropertyGroup>
      <_NormalizedDefaultCMakeProject>$([MSBuild]::NormalizePath($(MSBuildProjectDirectory),$(DefaultCMakeProject)))</_NormalizedDefaultCMakeProject>
    </PropertyGroup>

    <Error Condition="'%(NativeProjectReferenceNormalized.CMakeProject)' != '' and !Exists('%(NativeProjectReferenceNormalized.CMakeProject)')" Text="The MSBuild CMake SDK project associated with the project reference to '%(NativeProjectReferenceNormalized.Identity)' does not exist." />
    <Error Condition="!Exists('%(NativeProjectReferenceNormalized.Identity)')" Text="The CMakeLists.txt file at '%(NativeProjectReferenceNormalized.Identity)' does not exist." />

    <Error Condition="'%(NativeProjectReferenceNormalized.CMakeProject)' == '' and '$(_NormalizedDefaultCMakeProject)' == '' and !Exists('$(_NormalizedDefaultCMakeProject)')"
      Text="Each native project reference must be associated with an MSBuild CMake SDK project. Either set the 'CMakeProject' metadata on each ProjectReference item or set the 'DefaultCMakeProject' property." />

    <ItemGroup>
      <NativeProjectReferenceNormalized Condition="'%(CMakeProject)' == ''">
          <CMakeProject>$(_NormalizedDefaultCMakeProject)</CMakeProject>
      </NativeProjectReferenceNormalized>

      <NativeProjectReferenceNormalized>
          <CMakeListsFile>%(FullPath)</CMakeListsFile>
      </NativeProjectReferenceNormalized>
    </ItemGroup>
  </Target>

  <Target Name="ConsolidateNativeProjectReference"
          BeforeTargets="Build" >

    <ItemGroup>
      <_NativeProjectReferenceToBuild Include="%(NativeProjectReferenceNormalized.CMakeProject)"
                                      Condition="'%(NativeProjectReferenceNormalized.BuildNative)' == 'true'"
                                      AdditionalProperties="%(NativeProjectReferenceNormalized.AdditionalProperties)" />
    </ItemGroup>

    <RemoveDuplicates Inputs="@(_NativeProjectReferenceToBuild)">
      <Output TaskParameter="Filtered" ItemName="_UniqueNativeProjectReferenceToBuild" />
    </RemoveDuplicates>
    
    <MSBuild Projects="@(_UniqueNativeProjectReferenceToBuild)" />

    <Message Text= "Full native project references are :%(NativeProjectReferenceNormalized.Identity)" />

    <MSBuild Projects="$(MSBuildProjectFile)" 
             Targets="CopyNativeProjectBinariesFromFileApi"
             Properties="ReferencedCMakeLists=%(NativeProjectReferenceNormalized.Identity);
                         ReferencedCMakeProject=%(NativeProjectReferenceNormalized.CMakeProject);
                         %(NativeProjectReferenceNormalized.AdditionalProperties)"
             Condition="'@(NativeProjectReference)' != ''" />

  </Target>

  <Target Name="CopyNativeProjectBinariesFromFileApi">
    <!-- Get CMakeOutputDir and Configuration from the CMake project -->
    <MSBuild Projects="$(ReferencedCMakeProject)"
             Targets="GetCMakeOutputDir;GetConfiguration">
      <Output TaskParameter="TargetOutputs" ItemName="_CMakeProjectOutputs" />
    </MSBuild>

    <PropertyGroup>
      <_CMakeOutputDir>%(_CMakeProjectOutputs.CMakeOutputDir)</_CMakeOutputDir>
      <_Configuration>%(_CMakeProjectOutputs.Configuration)</_Configuration>
      <_SourceDirectory>$([System.IO.Path]::GetDirectoryName($(ReferencedCMakeLists)))</_SourceDirectory>
    </PropertyGroup>

    <!-- Try to get artifacts from File API -->
    <GetCMakeArtifactsFromFileApi 
      CMakeOutputDir="$(_CMakeOutputDir)"
      SourceDirectory="$(_SourceDirectory)"
      Configuration="$(_Configuration)">
      <Output TaskParameter="Artifacts" ItemName="_FileApiArtifacts" />
    </GetCMakeArtifactsFromFileApi>

    <!-- If File API returned artifacts, use them. Otherwise fall back to old logic -->
    <PropertyGroup>
      <_UseFileApi Condition="'@(_FileApiArtifacts)' != ''">true</_UseFileApi>
    </PropertyGroup>

    <ItemGroup Condition="'$(_UseFileApi)' == 'true'">
      <NativeProjectBinaries Include="@(_FileApiArtifacts)" />
    </ItemGroup>

    <Message Text="Using CMake File API to locate artifacts" Condition="'$(_UseFileApi)' == 'true'" />
    <Message Text="File API not available, falling back to legacy path detection" Condition="'$(_UseFileApi)' != 'true'" />

    <!-- Fall back to old logic if File API didn't work -->
    <MSBuild Projects="$(ReferencedCMakeProject)"
             Targets="GetOutputPathForProjectReference"
             Properties="ReferencedCMakeLists=$(ReferencedCMakeLists)"
             Condition="'$(_UseFileApi)' != 'true'">
      <Output TaskParameter="TargetOutputs" ItemName="_LegacyOutputFolder" />
    </MSBuild>

    <PropertyGroup Condition="'$(_UseFileApi)' != 'true'">
      <_LegacyOutputPath>%(_LegacyOutputFolder.Identity)</_LegacyOutputPath>
      <_IsMultiConfigurationGenerator>%(_LegacyOutputFolder.IsMultiConfigurationGenerator)</_IsMultiConfigurationGenerator>
    </PropertyGroup>

    <MSBuild Projects="$(MSBuildProjectFile)" 
             Targets="CopyNativeProjectBinaries"
             Properties="NativeProjectOutputFolder=$(_LegacyOutputPath);
                         ReferencedCMakeProject=$(ReferencedCMakeProject);
                         IsMultiConfigurationGenerator=$(_IsMultiConfigurationGenerator)"
             Condition="'$(_UseFileApi)' != 'true'" />

    <!-- Copy the binaries from File API if we have them -->
    <ItemGroup Condition="'$(_UseFileApi)' == 'true'">
      <_ArtifactsToCopy Include="@(NativeProjectBinaries)" Condition="Exists('%(Identity)')" />
    </ItemGroup>

    <Copy
      SourceFiles="@(_ArtifactsToCopy)"
      DestinationFiles="@(_ArtifactsToCopy -> '$(OutDir)%(Filename)%(Extension)')"
      SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
      OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
      Retries="$(CopyRetryCount)"
      RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
      UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)"
      Condition="'$(_UseFileApi)' == 'true'">
      <Output TaskParameter="DestinationFiles" ItemName="FileWrites" />
    </Copy>

    <ItemGroup Condition="'$(_UseFileApi)' == 'true'">
      <FileWrites Include="@(_ArtifactsToCopy -> '$(OutDir)%(Filename)%(Extension)')" />
    </ItemGroup>
  </Target>

  <Target Name="CopyAllNativeProjectReferenceBinaries" DependsOnTargets="ResolveCMakeNativeProjectReference;ConsolidateNativeProjectReference" />

</Project>
