<?xml version="1.0" encoding="utf-8"?>
<!-- Licensed to the .NET Foundation under one or more agreements. The .NET Foundation licenses this file to you under the MIT license. See the LICENSE file in the project root for more information. -->
<Project>
  <PropertyGroup>
    <!-- If ToolHostCmd is undefined, we default to assuming 'dotnet' is on the path -->
    <ToolHostCmd Condition="'$(ToolHostCmd)' == ''">dotnet</ToolHostCmd>

    <_SourceRewriterPath Condition="'$(MSBuildRuntimeType)' == 'core'">$(MSBuildThisFileDirectory)\..\tools\netcoreapp2.1\Microsoft.DotNet.SourceRewriter.dll</_SourceRewriterPath>
    <_SourceRewriterPath Condition="'$(MSBuildRuntimeType)' != 'core'">$(MSBuildThisFileDirectory)\..\tools\net472\Microsoft.DotNet.SourceRewriter.exe</_SourceRewriterPath>

    <_SourceRewriterCommand Condition="'$(MSBuildRuntimeType)' == 'core'">$(ToolHostCmd) $(_SourceRewriterPath)</_SourceRewriterCommand>
    <_SourceRewriterCommand Condition="'$(MSBuildRuntimeType)' != 'core' and '$(OS)' == 'Windows_NT'">$(_SourceRewriterPath)</_SourceRewriterCommand>
    <_SourceRewriterCommand Condition="'$(MSBuildRuntimeType)' != 'core' and '$(OS)' != 'Windows_NT'">mono --runtime=v4.0.30319 "$(_SourceRewriterPath)"</_SourceRewriterCommand>
  </PropertyGroup>

  <!--This target will run when building a source package and
    property GenerateInternalTypesSource is set to true. It will
    take the source files that need to be packaged, and it will use
    a roslyn-based task to convert all of the public exposed types on
    those files into internal types instead.-->
  <Target Name="GenerateInternalTypesSource" Condition="'$(GenerateInternalTypesSource)' == 'true' AND '@(SourcePackageFiles)' != ''">
    <ItemGroup>
      <_NewSourcesToPackage Include="@(SourcePackageFiles -> '$(IntermediateOutputPath)%(RecursiveDir)%(FileName)%(Extension)')">
        <OriginalIdentity>%(Identity)</OriginalIdentity>
      </_NewSourcesToPackage>
      <SourcePackageFiles Remove="@(SourcePackageFiles)" />
      <SourcePackageFiles Include="@(_NewSourcesToPackage)" />
      <FileWrites Include="@(SourcePackageFiles)" />
    </ItemGroup>

    <PropertyGroup>
      <_SourceRewriterCommand>$(_SourceRewriterCommand) &quot;@(SourcePackageFiles -> '%(OriginalIdentity)')&quot; &quot;$(IntermediateOutputPath.TrimEnd('/').TrimEnd('\\'))&quot;</_SourceRewriterCommand>
    </PropertyGroup>

    <Exec Command="$(_SourceRewriterCommand)"
          StandardOutputImportance="Low">
      <Output TaskParameter="ExitCode" PropertyName="SourceRewriterExitCode" />
    </Exec>
    <Error Condition="'$(SourceRewriterExitCode)' != '0'" Text="There was an error while rewriting the source with the command: $(_SourceRewriterCommand)" />
  </Target>
  
  <!--Target that will add the specified source files into the package.
      In order for this target to run, define SourcePackageFiles item by includding
      all source files that need to be packaged into it. Each source file must have the 
      PackagePath metadata defined, which is the location of where the source file will
      end up in the package-->
  <Target Name="AddSourceToFilesToPackage" BeforeTargets="GetFiles"
                                           DependsOnTargets="GenerateInternalTypesSource"
                                           Condition="'@(SourcePackageFiles)' != ''">
    <Error Condition="'%(SourcePackageFiles.PackagePath)' == ''"
           Text="Item &quot;%(SourcePackageFiles.Identity)&quot; does not define required metadata &quot;PackagePath&quot;" />

    <ItemGroup>
      <File Include="@(SourcePackageFiles)">
        <TargetPath>%(SourcePackageFiles.PackagePath)</TargetPath>
      </File>
    </ItemGroup>
  </Target>
</Project>
