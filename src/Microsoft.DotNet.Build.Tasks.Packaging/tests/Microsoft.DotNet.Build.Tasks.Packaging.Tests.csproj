<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFrameworks>$(TargetFrameworkForNETSDK);net472</TargetFrameworks>
    <LangVersion>Latest</LangVersion>
    <SignAssembly>false</SignAssembly>
    <NoWarn>$(NoWarn);xUnit2013</NoWarn>
    <!-- This project does weird stuff with packages/versions, ignore the cetral version warning -->
    <NoWarn>$(NoWarn);NU1008</NoWarn>
  </PropertyGroup>
  <ItemGroup>
    <Content Include="packageIndex.json" CopyToOutputDirectory="Always"/>
    <Content Include="FrameworkLists\**\*" CopyToOutputDirectory="Always"/>
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\src\Microsoft.DotNet.Build.Tasks.Packaging.csproj" />
  </ItemGroup>
  <ItemGroup>
    <PackageReference Include="Microsoft.Build"/>
    <PackageReference Include="Microsoft.Build.Tasks.Core"/>
    <PackageReference Include="Newtonsoft.Json" />
    <PackageReference Include="NuGet.Commands" />
    <PackageReference Include="NuGet.Packaging" />
    <PackageReference Include="NuGet.ProjectModel" />
    <PackageReference Include="System.Reflection.Metadata" />
    <PackageReference Include="FluentAssertions" />
  </ItemGroup>
  
  <!-- test packages - these packages aren't needed for compilation but are copied
                       to the output and used for testing. -->
  <ItemGroup>
    <TestPackage Include="System.Collections.Immutable" VersionOverride="1.7.1" />
    <TestPackage Include="Microsoft.Win32.Registry" VersionOverride="4.3.0" />
    <TestPackage Include="System.Runtime" VersionOverride="4.3.0" />
    <TestPackage Include="runtime.any.System.Runtime" VersionOverride="4.3.0" />
    <TestPackage Include="runtime.aot.System.Runtime" VersionOverride="4.3.0" />

    <PackageReference Include="@(TestPackage)" />
  </ItemGroup>
  
  <ItemGroup>
    <_candidatPackageFolders Include="$(NuGetPackageFolders)" />
  </ItemGroup>

  <!-- Find the packages from one of many package folders -->
  <Target Name="FindTestPackages"
          Inputs="%(_candidatPackageFolders.Identity)"
          Outputs="unused">
    <PropertyGroup>
      <_candidatePackageFolder>%(_candidatPackageFolders.Identity)</_candidatePackageFolder>
    </PropertyGroup>
    <ItemGroup>
      <TestPackage>
        <Folder Condition="Exists('$(_candidatePackageFolder)\%(Identity)\%(VersionOverride)')">$(_candidatePackageFolder)\%(Identity)\%(VersionOverride)</Folder>
        <!-- NuGet will restore to lower case folder and linux is case sensitive -->
        <Folder Condition="Exists('$(_candidatePackageFolder)\$([System.String]::new(&quot;%(Identity)\%(VersionOverride)&quot;).ToLower())')">$(_candidatePackageFolder)\$([System.String]::new(&quot;%(Identity)\%(VersionOverride)&quot;).ToLower())</Folder>
      </TestPackage>
    </ItemGroup>
  </Target>

  <!-- Check that we found the test packages and set up content items to copy them -->
  <Target Name="AddTestPackageContent"
          DependsOnTargets="FindTestPackages"
          AfterTargets="ResolveReferences">
     <Error Condition="'%(TestPackage.Folder)'==''"
            Text="Could not locate package '%(TestPackage.Identity)\%(TestPackage.VersionOverride)' under any of '$(NuGetPackageFolders)'" />
     <ItemGroup>
       <TestPackageContent Include="%(TestPackage.Folder)\**\*" LinkBase="packages\%(TestPackage.Identity)\%(TestPackage.VersionOverride)\" />
       <Content Include="@(TestPackageContent)" Link="%(TestPackageContent.LinkBase)%(RecursiveDir)%(FileName)%(Extension)" CopyToOutputDirectory="PreserveNewest" />
     </ItemGroup>
  </Target>
</Project>
