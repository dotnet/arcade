Test Plan
==========

This doc covers a test plan for the Virtual Machine Service. The Virtual Machine service is the primary service of the repro tool, hence given first priority for testing.
Currently these are just unit tests before checking in.

Assumptions
------------

- Testing this service in isolation independent of the other services - do not require mock for other services
- We do not want to test Service Fabric functionality
- We do not want to test Azure functionality
- Any new functionality should include new tests.

Contracts
----------
The types used in this doc are immutable and consumed by the VMS. They are generated by the type generator. Any change to the yaml definitions for these will need to be reviewed.

Notes about Reliable Collections in Service Fabric:
----------------------------------------------------

 - Do not modify an object of custom type returned by read operations - returns references not copies
 - Ensure that your IComparable<TKey> implementation is correct - used for merging checkpoints and rows.
 - Do use Update lock when reading an item with an intention to update it to prevent a certain class of deadlocks.
 - Consider keeping number of Reliable Collections per partition to be less than 1000. Prefer Reliable Collections with more items over more Reliable Collections with fewer items.
 - Consider keeping your items (for example, TKey + TValue for Reliable Dictionary) below 80 KBytes: smaller the better. This reduces the amount of Large Object Heap usage as well as disk and network IO requirements. Often, it reduces replicating duplicate data when only one small part of the value is being updated. Common way to achieve this in Reliable Dictionary, is to break your rows in to multiple rows.
 - Do handle InvalidOperationException. User transactions can be aborted by the system for variety of reasons. 
 - The default time-out is four seconds for all the Reliable Collection APIs
 - To achieve high availability for the Reliable Collections, each service should have at least a target and minimum replica set size of 3.
 - Read operations on the secondary may read versions that are not committed. Reads from Primary are always stable: can never be false progressed.

Functions
--------------

 **Task CheckExpiration(CancellationToken cancellationToken)**
 
_Inputs:_

  - A dictionary of VirtualMachineInfo
 
_Outputs:_

  - A dictionary of VirtualMachineInfo with non-expired machines
 
_Test setup:_

  - Create a set of VirtualMachineInfo objects in a dictionary.

_Tests:_

  - Check if virtual machine entry is deleted if the current time is past the expiry time.
  - Check that the exception is thrown if we are unable to delete virtual machine from the dictionary (non success return code)
  - Check if a physical machine entry is deleted if the current time is past the expiry time.
  - Check if a physical machine entry is reported as an error if the status is stuck in pending.

 **Task<VirtualMachineInfo> BeginCreateVirtualMachineAsync(VirtualMachineRequest request)**
 
 _Test setup:_

  - Create a set of snapshots in a dictionary

 _Inputs:_

 A VirtualMachineRequest which consists of 
   - id: string, null or valid
   - machineName: string, null or valid
   - owner: string, non-null
   - password: string, meets minimum requirements (3 lowercase, 1 upper case, 1 number and 1 special character that is not '\' or '-')
   - region: string, within a certain set
   - resourceGroup: string, null or valid
   - snapshotId: string, non-null
   - subscriptionId: string, non-null
   - userName: string, non-null
 
_Outputs:_

  - VirtualMachineInfo is created

_Tests:_

  - Ensure that given a valid set of parameters, a VirtualMachineInfo object is inserted into the dictionary.
  - Ensure that given the minimum set of parameters, a VirtualMachineInfo is created
  - Ensure that given a valid set of parameters, a VirtualMachineInfo for a Helix machine has the specific KeyVault password
  - Ensure lastUpdated is set to the current utc time for a new VirtualMachineInfo
  - Ensure status is set to the pending for a new VirtualMachineInfo
  - Ensure that given an invalid set of parameters that InvalidOperationException is thrown.
  - Ensure snapshot details match virtual machine request
     - is it the correct OS?
     - is it the correct type? (helix, azure)
  - Ensure that VirtualMachineInfo is given the minimum set of parameters
    
 **Task ProcessQueueMessageAsync(ITransaction tx, VirtualMachineRequest request, CancellationToken cancellationToken)**
 
 _Test setup:_

  - Create a set of VirtualMachineInfo objects in a dictionary named machines.
 
_Inputs:_

 A VirtualMachineRequest which consists of 
   - id: Guid, null or valid
   - machineName: string, null or valid
   - owner: string, non-null
   - password: string, meets minimum requirements (3 lowercase, 1 upper case, 1 number and 1 special character that is not '\' or '-')
   - region: string, within a certain set
   - resourceGroup: string, null or valid
   - snapshotId: string, non-null
   - subscriptionId: string, non-null
   - userName: string, non-null
   
_Outputs:_

 An updated dictionary of VirtualMachineInfo objects
 
_Tests:_

  - Ensure disk creation has happened with the right parameters.
  - Ensure the nic, pip, and vnet have the correct name and are in the same resource group.
  - Ensure the network security group has been attached.
  - Ensure the extension to add a new admin user and set it's password, is attached.
  - Ensure physical machine request is identified and sends the correct parameters required for a workitem.
  - Ensure that an Exception is thrown given the invalid parameters
  - Ensure a default username and password has been set.
  - Ensure if provisioning has not failed, that a reboot has been triggered and logged.
  - Ensure if provisioning has failed, the VirtualMachineInfo status is marked as Failed.
  - Ensure an exception is thrown in case any request fails.
  - Ensure if no exception is thrown that 
      - Virtual Machine status is Completed.
      - lastUpdated is set to current time
      - rdpuri value is set
      - Created is set to current time
  
 **ICreatable<INetworkSecurityGroup> GetNetworkSecurityGroupDefinition(IAzure azure, string region, string machineName, string resourceGroup)**
 
_Inputs:_

  Azure parameters including 
    - region: string
    - machineName: string
    - resourceGroup: string

_Outputs:_
  
  The network security group is attached to the definition.
  
_Tests:_

  - The REDMOND domain ips are always included
  - Both RDP and SSH ports are included
        
 **AttachPayload:**
 
_Tests:_

  - Ensure the right custom script extensions have been attached for the correct os.
  - Ensure SAS generated has a valid expiry date and permissions from the constants
  
 **Task CreatePhysicalMachineAsync(ITransaction tx, VirtualMachineRequest request, SnapshotInfo snapshot, CancellationToken cancellationToken)**
  
 _Test setup:_

  - Create a set of VirtualMachineInfo objects in a dictionary named machines.
 
_Inputs:_

 A VirtualMachineRequest with the following
   - id: Guid, null or valid
   - machineName: string, null or valid
   - owner: string, non-null
   - password: string, meets minimum requirements (3 lowercase, 1 upper case, 1 number and 1 special character that is not '\' or '-')
   - region: string, within a certain set
   - resourceGroup: string, null or valid
   - snapshotId: string, non-null
   - subscriptionId: string, non-null
   - userName: string, non-null
   
  A SnapshotInfo with the following
   - Created: DateTimeOffset
   - Expiry: DateTimeOffset
   - Id: string
   - Kind: SnapshotKind.Helix
   - Metadata: string
   - OperatingSystemType: string
   - Owner: string
   - Payload: valid url
   - Region: string
   - Request: SnapshotRequest,
   - Source: string
   - Status: string
   - uri: valid url

_Outputs:_

  Updated set with with VirtualMachineInfo with a physical machine type.
 
_Tests:_
 
  - Ensure that minimum parameters are set
  - Ensure that creation happens with all parameters set
  - Ensure that status is set to Creating
  - Ensure that an exception is thrown if all machines are in use.
  
 **Task ConnectPhysicalMachineAsync(Guid id, string ip, string machineName):**
 
_Inputs:_

  - Parameters:
      id: Guid,
      ip: string,
      machineName: string
      
_Outputs:_

  - The associated machine is updated in the dictionary
 
_Tests:_

  - Ensure that status is set to Completed
  - Ensure that machine exists
  - Ensure that exception is thrown if machine is not found
  - Ensure that the VirtualMachineInfo is updated with the proper IP and current time.
 
 **Task RemovePhysicalMachineAsync(Guid id):**

_Inputs:_

  - Parameters:
      id: Guid
      
_Outputs:_

  - The associated machine is removed from the dictionary
 
_Tests:_

  - Ensure that status is set to Deleting  
  - Ensure an exception is thrown if virtual machine does not exist
  - Ensure if an exception is thrown when
      - Status is Pending
      - Status is Error
    
**download-payload script**

_Test setup:_

  - Setup docker container for windows and linux
  
_Inputs_:

  - Payload URL: string 
 
_Outputs:_

  - A payload has been downloaded and unzipped in the right location
    
_Tests:_

  - Ensure an exception is thrown in case any request fails.
  - Ensure basic functionality has not regressed for download-payload
      - Is file downloaded?
      - Is workspace in correct folder?
      - Does it have the right permissions?
      - Do ancillary files exists?
  - Ensure mac physical machines invoke the correct dist command
    
 **Task<VirtualMachineInfo> GetVirtualMachineAsync(Guid id):**
 
_Inputs:_

  - Parameters:
      id: Guid
      
_Outputs:_

  - The associated machine is retrieved from the dictionary
 
_Tests:_

  - Ensure a VirtualMachineInfo is returned given a valid id
  - Ensure an exception is thrown if virtual machine does not exist
 
 **Task DeleteVirtualMachineAsync(Guid id, CancellationToken cancellationToken):**

_Inputs_:

  - id: Guid 
 
_Outputs:_

  - The associated vm is no longer present in the dictionary and the associated resource group has been deleted
    
_Tests:_

  - Ensure a delete request with the right parameters is returned given a valid id
  - Ensure the status is set to Deleting
  - Ensure an exception is thrown if 
      - Subscription does not exist
      - Resource group does not exists
      - Resource group has already been deleted
  - Ensure dictionary does not contain any copies of the deleted virtual machine
  - Ensure an exception is thrown if virtual machine does not exist
  
 **Task RenewVirtualMachineAsync(Guid id, TimeSpan additionalTime):**

_Inputs_:

  - id: Guid
  - additionalTime: TimeSpan
 
_Outputs:_

  - The associated vm is updated in the dictionary.
 
_Tests:_

  - Ensure a Failed or Pending machine cannot be renewed.
  - Ensure expiry on VirtualMachineInfo given a valid id is set to 1 more day from the current expiry timestamp.
  - Ensure the additional time cannot be more than 1 day.
  - Ensure expiry on VirtualMachineInfo given a valid id and optional time parameters is set to additional time more than current expiry timestamp.
  - Ensure an exception is thrown if virtual machine does not update with the optional time parameter
  - Ensure an exception is thrown if virtual machine does not exist
  - Ensure if an exception is thrown when
      - Status is Pending
      - Status is Error
  

  All strings are assumed UTF-8 encoded 