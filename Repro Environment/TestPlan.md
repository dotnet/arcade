Test Plan
==========

This doc covers a test plan for the Virtual Machine Service. The Virtual Machine service is the primary service of the repro tool, hence given first priority for testing.
Currently these are just unit tests before checking in.

Assumptions
------------

- Testing this service in isolation independent of the other services - do not require mock for other services
- We do not want to test Service Fabric functionality
- We do not want to test Azure functionality
- Any new functionality should include new tests.

Contracts
----------
The types used in this doc are immutable and consumed by the VMS. They are generated by the type generator. Any change to the yaml definitions for these will need to be reviewed.

Functions
--------------

 **CheckExpirationOfMachines:**
 
_Test setup:_

  - Create a set of VirtualMachineInfo objects in a dictionary.

_Tests:_

  - Check if virtual machine entry is deleted if the current time is past the expiry time.
  - Check that the exception is thrown if we are unable to delete virtual machine from the dictionary (non success return code)
  - Check if a physical machine entry is deleted if the current time is past the expiry time.
  - Check if a physical machine entry is reported as an error if the status is stuck in pending.

 **BeginCreateVirtualMachineAsync:**
 
  Creates a the VirtualMachineInfo is created with the following set of parameters
   - id: string, null or valid
   - machineName: string, null or valid
   - owner: string, non-null
   - password: string, meets minimum requirements (3 lowercase, 1 upper case, 1 number and 1 special chracter that is not '\' or '-')
   - region: enum, within a certain set
   - resourceGroup: string, null or valid
   - snapshotId: string, non-null
   - subscriptionId: string, non-null
   - userName: string, non-null

_Tests:_

  - Ensure that given a valid set of parameters, a VirtualMachineInfo object is inserted into the dictionary.
  - Ensure that given the minimum set of parameters, a VirtualMachineInfo is created
  - Ensure that given a valid set of parameters, a VirtualMachineInfo for a Helix machine has the specific KeyVault password
  - Ensure lastUpdated is set to the current utc time for a new VirtualMachineInfo
  - Ensure status is set to the pending for a new VirtualMachineInfo
  - Ensure that given an invalid set of parameters that InvalidOperationException is thrown.
  - Ensure snapshot details match virtual machine request
     - is it the correct OS?
     - is it the correct type? (helix, azure)
  - Ensure that VirtualMachineInfo is given the minimum set of parameters
    
 **ProcessQueueMessageAsync:**
 
_Tests:_

  - Ensure disk creation has happened with the right parameters.
  - Ensure the nic, pip, and vnet have the correct name and are in the same resource group.
  - Ensure the network security group has been attached.
  - Ensure the extension to add a new admin user and set it's password, is attached.
  - Ensure physical machine request is identified and sends the correct parameters required for a workitem.
  - Ensure a default username and password has been set.
  - Ensure if provisioning has not failed, that a reboot has been triggered and logged.
  - Ensure if provisioning has failed, the VirtualMachineInfo status is marked as Failed.
  - Ensure an exception is thrown in case any request fails.
  - Ensure if no exception is thrown that 
      - Virtual Machine status is Completed.
      - lastUpdated is set to current time
      - rdpuri value is set
      - Created is set to current time
  
        
 **AttachPayload:**
 
_Tests:_

  - Ensure the right custom script extensions have been attached for the correct os.
  - Ensure SAS generated has a valid expiry date and permissions from the constants
  
 **CreatePhysicalMachineAsync:**
 
_Tests:_
 
  - Ensure that minimum parameters are set
  - Ensure that status is set to Creating
  - Ensure that an exception is thrown if all machines are in use.
  
 **ConnectPhysicalMachineAsync:**
 
_Tests:_

  - Ensure that status is set to Completed
  - Ensure that machine exists
  - Ensure that the VirtualMachineInfo is updated with the proper IP and current time.
 
 **RemovePhysicalMachineAsync:**
 
_Tests:_

  - Ensure that status is set to Deleting  
  - Ensure an exception is thrown if virtual machine does not exist
  - Ensure if an exception is thrown when
      - Status is Pending
      - Status is Error
    
**Scripts**

_Test setup:_

  - Setup docker container for windows and linux
    
_Tests:_

  - Ensure an exception is thrown in case any request fails.
  - Ensure basic functionality has not regressed for download-payload
      - Is file downloaded?
      - Is workspace in correct folder?
      - Does it have the right permissions?
      - Do ancillary files exists?
  - Ensure mac physical machines invoke the correct dist command
    
 **GetVirtualMachine:**
 
_Tests:_

  - Ensure a VirtualMachineInfo is returned given a valid id
  - Ensure an exception is thrown if virtual machine does not exist
 
 **DeleteVM:**
 
_Tests:_

  - Ensure a delete request with the right parameters is returned given a valid id
  - Ensure the status is set to Deleting
  - Ensure an exception is thrown if 
      - Subscription does not exist
      - Resource group does not exists
      - Resource group has already been deleted
  - Ensure dictionary does not contain any copies of the deleted virtual machine
  - Ensure an exception is thrown if virtual machine does not exist
  
 **RenewVM:**
 
_Tests:_

  - Ensure a Failed or Pending machine cannot be renewed.
  - Ensure expiry on VirtualMachineInfo given a valid id is set to 1 more day from the current expiry timestamp.
  - Ensure the additional time cannot be more than 1 day.
  - Ensure expiry on VirtualMachineInfo given a valid id and optional time parameters is set to additional time more than current expiry timestamp.
  - Ensure an exception is thrown if virtual machine does not update with the optional time parameter
  - Ensure an exception is thrown if virtual machine does not exist
  - Ensure if an exception is thrown when
      - Status is Pending
      - Status is Error
  
